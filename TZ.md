# ТЕХНИЧЕСКОЕ ЗАДАНИЕ - Arbi45

## Получение цен, расчёт спреда и принятие решения о входе

### 1. Получение цен и мониторинг рынка

Все торговые пары, находящиеся в статусе READY, уже находятся в режиме активного мониторинга на всех подключенных биржах.

Терминал для каждой такой пары:
- поддерживает активные WebSocket-подписки:
  - на best bid / best ask,
  - на стаканы (первые 10 уровней),
- получает и хранит актуальное состояние рынка в реальном времени,
- обновляет данные без перезагрузки страницы в веб-интерфейсе.

**Переход пары из состояния PAUSE → READY означает:**
- запуск активного мониторинга цен,
- допуск пары к участию в торговой логике.

### 2. Предварительный быстрый фильтр по лучшему bid/ask

На каждом тике терминал выполняет быструю первичную оценку арбитражной ситуации:

1. Получает лучшие bid и ask по всем подключенным биржам.
2. Определяет:
   - биржу с максимальным bid (потенциальная биржа для Short),
   - биржу с минимальным ask (потенциальная биржа для Long).
3. Рассчитывает предварительный спред:

```
PreSpread = (BestBid - BestAsk) / BestAsk * 100%
```

Данный спред используется исключительно как быстрый фильтр, чтобы определить, есть ли потенциальная арбитражная ситуация.

Если:
```
PreSpread < Спреда входа
```
→ дальнейшие расчёты по стаканам не выполняются.

### 3. Финальный расчёт спреда по стаканам (основное торговое условие)

Если предварительный спред проходит быстрый фильтр:

1. Терминал фиксирует две биржи-кандидата:
   - дешёвую биржу для Long,
   - дорогую биржу для Short.
2. Для указанного пользователем объёма (либо его части при входе частями) выполняется расчёт:
   - средней цены исполнения (VWAP) по стакану:
     - для Long,
     - для Short.
3. После этого рассчитывается чистый спред входа с учётом рыночных комиссий:

```
CleanSpread = (VWAP_Short - VWAP_Long) / VWAP_Long * 100% - Комиссии
```

**Только CleanSpread используется как реальное торговое условие входа.**

**Решение о входе принимается строго по данным стаканов, а не только по лучшему bid/ask.**

### 4. Проверка ликвидности стакана

Арбитражная ситуация считается исполняемой, только если:
- весь указанный объём,
- либо очередная часть объёма при входе частями,

может быть полностью исполнена:
- на Long-бирже,
- на Short-бирже,

**без проскальзывания за пределы расчётных VWAP-цен.**

Если ликвидности недостаточно хотя бы на одной из двух бирж — арбитражная ситуация немедленно отбрасывается.

### 5. Финальное решение о входе в арбитраж

Вход в арбитраж разрешается только при одновременном соблюдении всех условий:

1. CleanSpread ≥ Спреда входа
2. ликвидность стакана позволяет исполнить весь объём (или его часть),
3. на обеих биржах достаточно доступной маржи.

**Только после этого терминал переходит к размещению рыночных ордеров.**

**До этого момента никакие ордера не выставляются.**

### 6. Примечание по рискам (зафиксировано в ТЗ)

В версии v1 терминала:
- используется только Cross-маржа,
- плечо устанавливается пользователем вручную на стороне биржи,
- терминал не управляет совокупной маржой аккаунта,
- терминал не ограничивает общий уровень риска.

**Пользователь осознанно принимает на себя все риски, связанные с выбором объёма, плеча, маржи и возможными экстремальными движениями рынка.**

## Логика входа и выхода из арбитража частями

### 1. Общие принципы работы частями

Для каждой торговой пары пользователь задаёт:
- общий объём позиции V (в монетах),
- количество ордеров N (от 1 до 10).

Терминал обязан:
- разделить общий объём строго на N равных частей,
- работать с каждой частью последовательно,
- обеспечивать, чтобы на обеих биржах по каждой части:
  - объём Long = объёму Short (с минимальным допустимым расхождением),
  - обе ноги были фактически исполнены.

Расчёт спреда и ликвидности для каждой части выполняется отдельно, исходя из объёма этой части.

### 2. Деление объёма на части

Объём делится следующим образом:

```
V_part = V / N
```

- Для каждой части используется одинаковая величина V_part.
- Расчёты спреда, ликвидности и маржи всегда выполняются именно для V_part, а не для всего объёма V.

### 3. Алгоритм входа в арбитраж частями

#### 3.1. Предварительные проверки перед входом в каждую часть

Перед тем как открыть очередную часть позиции, терминал обязан:

1. Пересчитать актуальный чистый спред входа (CleanSpread) для объёма V_part:
   - используя данные стаканов (VWAP) по обеим биржам-кандидатам,
   - с учётом комиссий.
2. Проверить ликвидность стаканов:
   - объём V_part должен полностью исполняться в стакане Long-биржи,
   - объём V_part должен полностью исполняться в стакане Short-биржи,
   - без выхода за пределы расчётных VWAP-цен.
3. Проверить доступную маржу на обеих биржах:
   - маржи должно хватать для открытия очередной части на обеих ногах.

Если хотя бы одно из условий:
- CleanSpread ≥ Спреда входа,
- достаточная ликвидность для V_part,
- достаточная маржа на обеих биржах,

не выполняется — очередная часть не открывается, терминал не выставляет ордера.

#### 3.2. Размещение ордеров для части

Если все проверки успешно пройдены:

1. Терминал одновременно отправляет два рыночных ордера:
   - ордер на покупку (Long) на дешёвой бирже,
   - ордер на продажу (Short) на дорогой бирже.
2. Оба ордера выставляются на объём V_part (с учётом формата конкретной биржи).

#### 3.3. Ожидание исполнения ордеров

После отправки ордеров терминал:
- отслеживает фактическое исполнение обоих ордеров:
  - по объёму,
  - по средневзвешенной цене исполнения (VWAP фактического исполнения),
- ожидает, пока каждая нога:
  - будет либо полностью исполнена,
  - либо станет понятно, что ордер не может быть исполнен (ошибка, отмена, недостаточная ликвидность и т.п.).

#### 3.4. Условие успешного открытия части

Часть считается успешно открытой, если выполняются все условия:

1. Оба рыночных ордера фактически исполнены.
2. Исполненные объёмы Long и Short по этой части равны (с допустимым минимальным расхождением, зависящим от требований биржи).
3. По обеим ногам зафиксированы:
   - фактический объём,
   - средняя цена исполнения (VWAP).

После успешного открытия части:
- терминал учитывает набранную часть в общей позиции,
- продолжает мониторинг спреда и условий для следующей части,
- в секцию «Торговля» записывается лог в формате, описанном в разделе «Логи» (например, Ордера 1/3, Ордера 2/3 и т.п.).

#### 3.5. Ошибки при входе в часть (асимметрия ног)

Если при попытке открыть очередную часть возникает ситуация, когда:
- одна нога (Long или Short) исполнена полностью или частично,
- вторая нога:
  - не исполнилась,
  - либо не может быть исполнена в требуемом объёме,
  - либо по ней уже исчез необходимый спред,

то терминал обязан:

1. Сразу закрыть рыночным ордером исполненную ногу (полностью).
2. Перевести торговую пару в статус ERROR.
3. Отправить в секцию «ERROR» лог с описанием ситуации:
   - какая нога успела исполниться,
   - по какой причине не была открыта вторая нога.

В этом случае часть считается неуспешной, позиция по этой части не учитывается.

### 4. Продолжение набора позиции

Если одна или несколько частей были успешно открыты:
- общая позиция по паре частично набрана,
- пара находится в статусе TRADE.

Дальнейший набор следующих частей происходит по тому же алгоритму:

1. Проверка актуального чистого спреда входа для V_part.
2. Проверка ликвидности для V_part.
3. Проверка доступной маржи.
4. Одновременный вход двумя ордерами.
5. Проверка симметрии исполнения ног.

#### 4.1. Ситуация, когда условия для следующей части не выполняются

Если после открытия одной или нескольких частей:
- спред входа становится меньше заданного,
- или ликвидности в стакане недостаточно для V_part,
- или маржи недостаточно,

то:
- дальнейший набор прекращается,
- терминал не пытается открыть следующие части,
- уже набранные части продолжают удерживаться как действующая позиция,
- пара остаётся в статусе TRADE и ждёт выполнения условий выхода.

В этом случае статус ERROR не выставляется, так как текущая позиция симметрична и корректно открыта.

### 5. Логика выхода из арбитража частями

Выход из арбитража реализуется зеркально логике входа:
- общий объём позиции делится на те же N частей (или на фактически набранное количество частей),
- выход выполняется частями, в том же порядке и объёмах V_part.

#### 5.1. Проверки перед выходом каждой части

Перед закрытием каждой части терминал обязан:

1. Рассчитать спред выхода для объёма, который планируется закрыть (по стаканам, через VWAP для объёма части).
2. Проверить ликвидность в стаканах обеих бирж:
   - чтобы объём части можно было полностью закрыть по рынку,
   - без выхода за пределы расчётных VWAP-цен.

Проверка доступной маржи на этом этапе не выполняется.

#### 5.2. Размещение ордеров на выход части

Если условия выхода выполняются:

1. Терминал одновременно отправляет:
   - рыночный ордер на закрытие Long на одной бирже,
   - рыночный ордер на закрытие Short на другой бирже,
   - на объём очередной части.
2. Аналогично входу:
   - отслеживается исполнение обоих ордеров,
   - проверяется равенство закрытых объёмов по обеим ногам.

#### 5.3. Успешное закрытие части

Часть считается успешно закрытой, если:
- обе ноги полностью закрыты,
- объёмы закрытых Long и Short по части равны (с допустимой погрешностью),
- по обеим ногам зафиксированы фактические цены выхода.

После закрытия всех частей:
- арбитражный цикл считается завершённым,
- выполняется расчёт PNL по циклу,
- PNL и количество завершённых арбитражных циклов записываются в БД и отображаются во вкладке «Бот».

#### 5.4. Ошибки при выходе части (асимметрия ног при закрытии)

Если при выходе из очередной части:
- одна нога закрылась,
- вторая нога не закрылась или закрылась не полностью,

терминал действует по тому же принципу, что и при входе:

1. Закрывает оставшуюся ногу рыночным ордером (как только это возможно).
2. Переводит пару в статус ERROR.
3. Пишет лог в секцию «ERROR» с описанием ситуации.

## Статусы торговой пары и их переходы

Каждая торговая пара в терминале может находиться в одном из следующих статусов:
- PAUSE
- READY
- TRADE
- ERROR

### Статус PAUSE

Статус PAUSE означает:
- торговая пара добавлена в систему, параметры сохранены,
- мониторинг цен и стаканов по этой паре не ведётся,
- торговая логика по этой паре не активна,
- по этой паре не может быть открыто новых арбитражных сделок.

**Переходы:**
- из PAUSE → READY:
  - при нажатии пользователем кнопки «Старт» во вкладке «Бот»;
  - при этом запускается мониторинг цен и торговая логика для этой пары.
- из PAUSE → PAUSE:
  - при редактировании/удалении параметров пары (если будет реализовано в следующих версиях).

### Статус READY

Статус READY означает:
- по паре включён активный мониторинг цен и стаканов на всех подключенных биржах,
- терминал:
  - подписан на WebSocket-потоки,
  - актуализирует best bid/ask и стаканы (первые 10 уровней) по всем биржам,
- торговая логика готова к входу в арбитраж, но позиции ещё не открыты.

**Переходы:**
- из READY → TRADE:
  - когда выполняются все условия входа:
    - достаточный чистый спред входа по объёму (или части объёма),
    - достаточная ликвидность,
    - достаточная маржа на обеих биржах,
  - и хотя бы одна часть объёма успешно открыта (симметрично на обеих биржах).
- из READY → PAUSE:
  - при нажатии пользователем кнопки «Пауза» до начала входа в арбитраж (когда ещё нет открытых позиций).
- из READY → ERROR:
  - в случае критических ошибок логики или синхронизации (например, если терминал при READY обнаруживает, что на бирже уже есть открытая позиция по данной паре, что не соответствует внутреннему состоянию).

### Статус TRADE

Статус TRADE означает:
- по паре есть открытая арбитражная позиция (полностью или частично),
- торговый цикл активен:
  - либо продолжается набор части позиции,
  - либо ожидается выполнение условий выхода.

**Переходы:**
- из TRADE → READY:
  - после успешного завершения полного арбитражного цикла:
    - все части объёма закрыты на обеих биржах симметрично,
    - PNL рассчитан и записан,
    - в логах зафиксировано завершение цикла.
- из TRADE → PAUSE:
  - при нажатии пользователем кнопки «Пауза»:
    - терминал обязан:
    - закрыть все открытые позиции по данной паре рыночными ордерами на обеих биржах,
    - дождаться фактического закрытия,
    - после этого перевести пару в PAUSE.
- из TRADE → ERROR:
  - при возникновении ошибок типа:
    - одна нога открылась/закрылась, вторая — нет;
    - невозможно закрыть позицию при выходе;
    - критические ошибки связи или исполнений, при которых симметрия ног нарушена.

### Статус ERROR

Статус ERROR означает:
- по паре возникла ошибка в торговом процессе,
- внутренняя логика не может гарантировать:
  - симметричность позиций,
  - корректность текущего состояния,
- торговая логика по этой паре остановлена до вмешательства пользователя.

При ERROR:
- в секцию «ERROR» пишется лог с описанием проблемы,
- становится доступна кнопка «Сброс» (Reset).

**Переходы:**
- из ERROR → PAUSE:
  - при нажатии кнопки «Сброс» терминал:
    - принудительно закрывает все открытые позиции по данной паре на обеих биржах рыночными ордерами,
    - после успешного закрытия переводит пару в статус PAUSE.
- из ERROR → ERROR:
  - при повторных ошибках или неудачных попытках ликвидации.

## Обработка ошибок

Ниже описываются основные типы ошибок и поведение терминала. Все события ошибок логируются в секцию «ERROR» во вкладке «Логи» в текстовом формате, описанном в ТЗ (без изменений структуры логов).

### 1. Одна нога не открылась при входе в часть

**Ситуация:**
- терминал отправил два рыночных ордера (Long и Short) для очередной части,
- одна нога была исполнена (полностью или частично),
- вторая нога:
  - не была исполнена,
  - либо была отменена биржей,
  - либо не может быть исполнена в нужном объёме.

**Действия терминала:**
1. Немедленно закрыть уже исполненную ногу рыночным ордером.
2. Перевести торговую пару в статус ERROR.
3. Записать в секцию «ERROR» лог с описанием ситуации.

### 2. Одна нога не закрылась при выходе из части

**Ситуация:**
- терминал отправил два рыночных ордера на закрытие части,
- одна нога закрыта,
- вторая нога не закрыта или закрыта не полностью.

**Действия терминала:**
1. Пытаться закрыть оставшуюся ногу рыночным ордером (при первой возможности).
2. После попытки закрытия:
   - если позиция по паре остаётся несбалансированной — статус ERROR.
3. Записать подробный лог в секцию «ERROR».

### 3. Недостаточно маржи для открытия позиции

**Ситуация:**
- при проверке перед входом очередной части терминал получает от биржи или рассчитывает, что:
  - недоступно достаточное количество маржи для открытия позиции на одной из бирж.

**Действия:**
1. Очередная часть не открывается, ордера не отправляются.
2. Торговая пара может:
   - либо остаться в READY (если позиции ещё не было),
   - либо остаться в TRADE (если часть позиции уже набрана).
3. Если при попытке входа биржа возвращает ошибку недостатка маржи уже после отправки ордера → см. сценарий «одна нога не открылась» (п.1) и переход в ERROR.

### 4. Потеря связи с биржей

Потеря связи может произойти:
- до входа в позицию,
- во время входа,
- во время удержания позиции (статус TRADE),
- во время выхода.

#### 4.1. Потеря связи до входа в позицию (READY, без открытых ног)

- Если терминал ещё не открыл ни одну ногу:
  - новые части не открываются,
  - пара остаётся в READY,
  - торговых действий не предпринимается до восстановления связи.
- В секцию «ERROR» может быть записано предупреждение о временной потере связи (по желанию).

#### 4.2. Потеря связи во время попытки входа части

- Если связь потеряна в момент, когда терминал не уверен, была ли открыта одна из ног:
  - при восстановлении связи терминал должен запросить состояние позиций и ордеров на обеих биржах,
  - если обнаруживает, что:
    - одна нога была открыта, а вторая — нет → немедленно закрывает открытую ногу и ставит статус ERROR;
    - обе ноги не открыты → остаётся в READY/TRADE (в зависимости от уже набранных частей), часть считается неуспешной и не учитывается.

#### 4.3. Потеря связи во время активного арбитража (позиция уже открыта, статус TRADE)

В версии v1 терминала:
- не реализован стоп-лосс,
- не реализовано аварийное принудительное закрытие позиции по таймеру при длительной потере связи.

**Поведение:**
- При потере связи с биржей во время статуса TRADE:
  - торговая пара остаётся в статусе TRADE,
  - терминал ожидает восстановления соединения с биржей (или биржами),
  - активные позиции по данной паре не закрываются автоматически.

После восстановления связи терминал:
1. Актуализирует данные о позициях и ценах.
2. Пересчитывает:
   - текущий спред выхода,
   - возможность закрытия позиции по условиям выхода.
3. Если спред выхода удовлетворяет заданным условиям:
   - пытается закрыть позицию частями по стандартным правилам выхода.
4. Если спред выхода не удовлетворяет условиям:
   - позиция продолжается,
   - терминал не предпринимает дополнительных действий.

**Пользователь осознанно принимает на себя риск возможных значительных убытков при резких движениях рынка во время потери связи. Терминал v1 не ограничивает максимальный убыток и не гарантирует закрытие позиции при потере связи.**

### 5. Ликвидация позиции

В версии v1:
- события ликвидации позиции на бирже терминалом дополнительно не обрабатываются,
- специализированная логика ликвидации (уведомления, отдельные статусы) не реализована.

Пользователь принимает на себя риск возникновения ликвидации и её последствий на стороне биржи.

## Поведение при перезапуске терминала

При перезапуске сервера (VPS), на котором работает терминал:

1. Терминал инициирует переподключение к биржам и выполняет:
   - запрос открытых позиций по всем поддерживаемым биржам,
   - запрос открытых ордеров по всем поддерживаемым биржам.
2. Все торговые пары, известные терминалу (записанные в БД), переводятся в статус PAUSE.
3. Для пар, по которым терминал обнаруживает открытые позиции на биржах:
   - терминал считает, что:
     - до перезапуска был активный арбитраж,
     - либо состояние позиций вышло из-под контроля логики терминала.
   - Поведение v1:
     - терминал принудительно закрывает все обнаруженные позиции по этой паре на обеих биржах рыночными ордерами,
     - после успешного закрытия:
       - пишет соответствующий лог в секцию «ERROR» или «Торговля» (по решению реализации),
       - оставляет пару в статусе PAUSE.
4. Для пар, по которым на биржах не обнаружено открытых позиций:
   - пары остаются в PAUSE,
   - торговая логика снова может быть запущена пользователем вручную через кнопку «Старт».

## Ограничения версии v1 и требования к производительности

### 1. Общие ограничения версии v1

Текущая версия терминала (v1) является первой рабочей версией, предназначенной для:
- запуска в реальных рыночных условиях,
- тестирования торговой логики,
- выявления слабых мест архитектуры,
- накопления статистики по арбитражным связкам.

В версии v1 осознанно отсутствуют следующие механизмы:
- автоматический стоп-лосс,
- ограничение максимального убытка по сделке,
- ограничение максимального убытка по аккаунту,
- автоматическое управление плечом,
- автоматическое перераспределение маржи между парами,
- защита от ликвидаций,
- дополнительные хеджирующие механизмы.

**Пользователь полностью принимает на себя все торговые и рыночные риски, связанные с работой терминала в версии v1.**

### 2. Ограничения по количеству торговых сущностей

В версии v1 устанавливаются следующие ограничивающие параметры:
- **Максимальное количество торговых пар в системе:** до 30 пар (настраивается в конфигурационном файле на VPS).
- **Максимальное количество одновременно активных пар в статусе READY:** до 10 пар.
- **Максимальное количество одновременно активных арбитражных циклов (статус TRADE):** до 10 циклов.
- **Максимальное количество частей (ордеров) для одной торговой пары:** от 1 до 10.

### 3. Ограничения по рынку и инструментам

В версии v1 терминал:
- работает исключительно на фьючерсных рынках (USDT-M),
- использует только Cross-маржу,
- работает только с рыночными ордерами (Market),
- не использует лимитные ордера,
- не использует пост-онли, айсберги и другие типы ордеров.

### 4. Требования к производительности внутренних расчётов

Производительность терминала разделяется на два уровня:
- внутренние вычисления (логика терминала),
- сетевые задержки (WebSocket, REST, API бирж).

В версии v1 целевые ориентиры по внутренней логике:
- **обновление данных по стакану одной пары:** до 0.5–1 мс,
- **расчёт предварительного спреда (best bid/ask):** до 0.1–0.3 мс,
- **расчёт:** VWAP, CleanSpread, проверки ликвидности, проверка маржи для одной торговой пары: до 1–3 мс.

**Основная задержка торговых решений обусловлена:**
- задержками сетевых соединений,
- скоростью обработки данных на стороне бирж,
- задержками WebSocket-каналов.

Терминал версии v1 не является HFT-системой и не ориентирован на микросекундные задержки.

### 5. Требования к стабильности работы

Терминал обязан:
- работать в режиме 24/7 на VPS,
- поддерживать:
  - автоматическое переподключение к WebSocket при обрывах,
  - повторную попытку подписки на потоки данных,
- корректно восстанавливать работоспособность после:
  - кратковременных сетевых сбоев,
  - перезапуска процесса терминала,
  - временной недоступности API бирж.

При восстановлении соединений терминал обязан:
- обновить:
  - стаканы,
  - best bid/ask,
  - данные по позициям,
  - открытые ордера,
- привести внутреннее состояние системы в соответствие с фактическим состоянием на биржах.

### 6. Требования к отказоустойчивости

В версии v1:
- допускается ручное вмешательство пользователя при критических ошибках,
- допускается использование кнопки:
  - «Пауза»,
  - «Сброс»,
  как основного механизма восстановления системы.

Терминал не обязан:
- автоматически восстанавливаться после тяжёлых логических сбоев без участия пользователя,
- сохранять торговые циклы при нестандартных аварийных завершениях процесса.

### 7. Ограничения по безопасности

В версии v1:
- доступ к веб-интерфейсу:
  - осуществляется по IP-адресу VPS,
  - защищается логином и паролем,
- терминал не реализует:
  - двухфакторную аутентификацию,
  - систему ролей,
  - разграничение прав доступа.

**Ответственность за безопасность доступа к VPS и веб-интерфейсу полностью лежит на пользователе.**

## Веб-интерфейс торгового терминала

### 1. Общие принципы работы веб-интерфейса

Веб-интерфейс терминала:
- работает в связке Backend + Frontend,
- оба компонента размещаются на одном VPS,
- доступ осуществляется:
  - по IP-адресу VPS,
  - через браузер.

Доступ к веб-интерфейсу обязательно защищён логином и паролем:
- логин и пароль:
  - задаются в конфигурационном файле на VPS,
  - не изменяются через веб-интерфейс.

Веб-интерфейс работает в режиме реального времени:
- данные обновляются без перезагрузки страницы,
- все изменения статусов, балансов, пар, логов отображаются сразу.

### 2. Структура веб-интерфейса

Веб-интерфейс состоит из трёх основных вкладок:
1. Вкладка «Бот»
2. Вкладка «Подключения»
3. Вкладка «Логи»

## Вкладка «Бот»

### 3. Назначение вкладки «Бот»

Вкладка «Бот» предназначена для:
- управления торговыми парами,
- запуска и остановки арбитража,
- отображения статусов пар,
- отображения статистики по каждой паре.

### 4. Блок «Подключенные биржи»

В верхней части вкладки отображается список подключенных бирж.

Для каждой подключенной биржи отображается:
- название биржи,
- доступная маржа (баланс по фьючерсному аккаунту).

**Биржи, которые не подключены, во вкладке «Бот» не отображаются.**

**При подключении новой биржи во вкладке «Подключения» — она автоматически появляется во вкладке «Бот» без перезагрузки страницы.**

### 5. Кнопка «Добавить торговую пару»

На вкладке «Бот» присутствует кнопка «Добавить торговую пару».

При нажатии открывается модальное окно с полями:

1. **Название торговой пары**
   - формат: BTCUSDT, AVAXUSDT и т.п.,
   - терминал обязан автоматически преобразовывать формат под требования каждой биржи.
2. **Объём (в монетах)**
   - общий объём позиции.
3. **Спред входа (в процентах)**
   - только положительное число.
4. **Спред выхода (в процентах)**
   - может быть положительным или отрицательным числом.
5. **Количество ордеров**
   - целое число,
   - от 1 до 10.

Кнопки:
- «Добавить»
- «Отмена»

#### Валидация полей при добавлении торговой пары

Перед добавлением обязательно проверяется:
- формат торговой пары,
- Спред входа > Спред выхода,
- Спред входа > 0,
- Количество ордеров ∈ [1; 10],
- общее количество добавленных торговых пар не превышает лимит, заданный в конфигурации (до 30).

#### Состояние новой торговой пары

После добавления:
- торговая пара:
  - автоматически добавляется в список без перезагрузки страницы,
  - создаётся в статусе PAUSE,
  - в мониторинг не поступает, пока пользователь не нажмёт «Старт».

### 6. Список торговых пар

Для каждой торговой пары в списке отображается:

#### Основные параметры:

1. Статус торговой пары:
   - PAUSE
   - READY
   - TRADE
   - ERROR
2. Название торговой пары
3. Объём
4. Спред входа
5. Спред выхода
6. Количество ордеров

#### Статистика по паре:

Отображаются:
- **Количество сделок** (сколько арбитражных циклов было завершено по данной паре),
- **PNL в USDT** (суммарная прибыль по завершённым арбитражным циклам).

#### Кнопки управления:

В зависимости от статуса пары отображаются следующие кнопки:

**Если статус PAUSE:**
- кнопка «Старт»
- кнопка «Удалить»

**Если статус READY:**
- кнопка «Пауза»
- кнопка «Удалить»

**Если статус TRADE:**
- кнопка «Пауза»
  - При нажатии:
    - терминал обязан зеркально закрыть все позиции по паре,
    - после закрытия перевести пару в статус PAUSE.

**Если статус ERROR:**
- кнопка «Сброс»
  - При нажатии «Сброс»:
    - терминал:
      - принудительно закрывает все открытые позиции по данной паре на обеих биржах,
      - после закрытия переводит пару в статус PAUSE,
    - кнопка «Старт» снова становится доступной.

**Все изменения кнопок и статусов отображаются в реальном времени без перезагрузки страницы.**

## Вкладка «Подключения»

### 7. Назначение вкладки «Подключения»

Вкладка «Подключения» предназначена для:
- подключения бирж,
- управления состоянием подключений,
- отображения балансов по биржам.

### 8. Подключение бирж

Для каждой биржи реализовано подключение через:
- API Key
- Secret Key
- Passphrase (для OKX и BingX)

После ввода данных:
- происходит проверка корректности ключей,
- данные сохраняются в базе данных.

### 9. Управление подключенными биржами

Для каждой подключенной биржи доступны кнопки:

**«Отключить»**
- биржа:
  - перестаёт получать ценовые котировки,
  - не участвует в арбитраже,
- кнопка меняется на «Включить» без перезагрузки страницы.

**«Включить»**
- биржа снова:
  - начинает получать котировки,
  - участвует в арбитраже.

**«Удалить данные»**
- полностью удаляет:
  - API Key,
  - Secret,
  - Passphrase,
- позволяет заново ввести данные для этой биржи.

#### Ограничения на управление биржами

Пользователь не может:
- отключить биржу,
- удалить данные биржи,

если хотя бы одна торговая пара находится в статусе TRADE.

#### Отображение балансов

Напротив каждой подключенной биржи отображается:
- доступная маржа (баланс) по фьючерсному аккаунту.

## Вкладка «Логи»

### 10. Назначение вкладки «Логи»

Вкладка «Логи» предназначена для отображения:
- торговых событий,
- ошибок в логике работы,
- системных сообщений.

### 11. Секции логов

Во вкладке «Логи» присутствуют две основные секции:
1. Секция «Торговля»
2. Секция «ERROR»

#### Секция «Торговля»

Сюда поступают логи:
- открытия позиций,
- закрытия позиций,
- завершения арбитражных циклов.

Форматы сообщений строго соответствуют ТЗ и не изменяются.

#### Секция «ERROR»

Сюда поступают логи:
- ошибок логики,
- ошибок открытия/закрытия ног,
- ошибок соединений,
- нехватки маржи,
- асимметрии позиций.

Форматы сообщений строго текстовые, без структурированных объектов.

**Вкладка «Логи» обновляется в режиме реального времени без перезагрузки страницы.**

## Работа с биржами и API-логикой

### 1. Список поддерживаемых бирж (v1)

В версии v1 терминал поддерживает следующие фьючерсные биржи (USDT-M):
- BYBIT
- BINGX
- BITGET
- GATE
- OKX
- HTX

Терминал работает исключительно с фьючерсными контрактами USDT-M. Спот-рынки и другие типы деривативов в v1 не используются.

### 2. Типы используемых API-подключений

Для каждой подключенной биржи терминал использует:

**REST API:**
- для отправки рыночных ордеров,
- для получения балансов,
- для получения открытых позиций,
- для получения открытых ордеров,
- для закрытия позиций,
- для проверки доступной маржи.

**WebSocket API:**
- для получения best bid / best ask,
- для получения стаканов (первые 10 уровней),
- для получения обновлений по ордерам и сделкам,
- для получения обновлений по позициям (если поддерживается биржей).

### 3. Унификация форматов торговых пар

Пользователь вводит торговые пары в универсальном формате:
- BTCUSDT
- AVAXUSDT
- ETHUSDT

Терминал обязан:
- автоматически:
  - преобразовывать формат пары под требования конкретной биржи,
  - хранить внутреннее «универсальное имя пары»,
- поддерживать сопоставление:
  - универсальное имя ↔ формат конкретной биржи.

Данная логика должна быть прозрачной для пользователя и не требовать ручной настройки.

### 4. Подключение бирж через API-ключи

Подключение биржи выполняется во вкладке «Подключения» через ввод:
- API Key
- Secret Key
- Passphrase (для OKX и BINGX)

После ввода данных терминал обязан:

1. Выполнить тестовый запрос к бирже:
   - проверить валидность ключей,
   - проверить доступ к фьючерсному аккаунту.
2. В случае успеха:
   - сохранить ключи в БД.
3. В случае ошибки:
   - отклонить подключение,
   - отобразить ошибку пользователю.

### 5. Безопасность хранения API-ключей

В версии v1:
- API-ключи:
  - хранятся в базе данных,
  - используются только серверной частью терминала.
- передача ключей между backend и frontend:
  - не допускается.

**За безопасность VPS, файловой системы и БД отвечает пользователь.**

### 6. Включение и отключение бирж

Для каждой подключенной биржи доступно:

**Состояние «Включена»**
- биржа:
  - участвует в расчёте спреда,
  - поставляет стаканы и best bid/ask,
  - участвует в арбитраже.

**Состояние «Отключена»**
- биржа:
  - не участвует в расчётах спреда,
  - не получает запросов на открытие и закрытие ордеров,
  - временно исключена из торговой логики.

#### Ограничения

Пользователь не может:
- отключить биржу,
- удалить данные биржи,

если хотя бы одна торговая пара находится в статусе TRADE.

### 7. Получение рыночных данных

Для каждой торговой пары в статусе READY терминал:
- поддерживает активные подписки:
  - на best bid / best ask,
  - на стаканы (первые 10 уровней),
- обновляет данные:
  - в реальном времени,
  - без перезагрузки страницы.

Обновление данных используется для:
- предварительного фильтра по спреду,
- расчёта VWAP,
- расчёта CleanSpread,
- проверки ликвидности.

### 8. Выставление рыночных ордеров

В версии v1 терминал использует только рыночные ордера (Market):
- для входа в позицию,
- для выхода из позиции,
- для аварийного закрытия.

Терминал не использует:
- лимитные ордера,
- пост-онли ордера,
- айсберги,
- триггер-ордера.

### 9. Контроль фактического исполнения ордеров

После отправки каждого рыночного ордера терминал обязан:
- получить подтверждение:
  - размещения ордера,
  - начала исполнения,
  - завершения исполнения,
- зафиксировать:
  - фактический исполненный объём,
  - среднюю цену исполнения (VWAP фактического исполнения).

**Часть позиции считается успешно открытой или закрытой только после фактического исполнения обеих ног.**

### 10. Работа с частичными исполнениями

В версии v1:
- терминал учитывает факт частичных исполнений рыночных ордеров со стороны биржи,
- часть считается корректной только при симметричном исполнении обеих ног,
- при асимметрии применяется логика:
  - аварийного закрытия,
  - перевода пары в статус ERROR.

### 11. Получение балансов и маржи

Терминал обязан:
- регулярно получать с бирж:
  - баланс фьючерсного аккаунта,
  - доступную маржу,
- использовать эти данные:
  - для проверки возможности открытия очередной части позиции,
  - для отображения информации во вкладке «Бот» и «Подключения».

### 12. Синхронизация состояния с биржами

Терминал обязан периодически выполнять:
- запрос:
  - открытых позиций,
  - открытых ордеров,
- сверку:
  - внутреннего состояния терминала,
  - фактического состояния на бирже.

При выявлении несоответствий:
- торговая пара переводится в статус ERROR,
- формируется лог в секцию «ERROR».

### 13. Ограничения запросов и защита от банов

Терминал обязан:
- соблюдать лимиты запросов бирж,
- использовать:
  - разумную частоту REST-запросов,
  - WebSocket как основной источник данных,
- корректно обрабатывать:
  - ошибки лимитов,
  - временные баны,
  - ошибки сети.

## Хранение данных, база данных и сущности системы

### 1. Общие принципы хранения данных

Терминал использует централизованную базу данных, размещённую на том же VPS, что и Backend.

База данных предназначена для хранения:
- настроек системы,
- подключений к биржам,
- торговых пар,
- параметров арбитража,
- статистики торгов,
- результатов арбитражных циклов,
- логов.

База данных должна обеспечивать:
- сохранность данных при перезапуске терминала,
- восстановление состояния после сбоев,
- доступ Backend-компоненту в режиме 24/7.

Frontend не имеет прямого доступа к базе данных и работает только через Backend API.

### 2. Основные сущности системы

В базе данных должны быть представлены следующие логические сущности:
- Пользователь (в версии v1 — один пользователь)
- Биржи
- API-ключи
- Торговые пары
- Арбитражные циклы
- Части ордеров (части позиции)
- Позиции
- Балансы
- Логи

### 3. Сущность «Пользователь»

В версии v1:
- система рассчитана на одного пользователя,
- пользователь:
  - не хранится как полноценная таблица,
  - а определяется через:
    - логин,
    - пароль,
    - хранимые в конфигурационном файле.

### 4. Сущность «Биржа»

Для каждой поддерживаемой биржи хранится:
- уникальный идентификатор биржи,
- название биржи,
- статус подключения:
  - CONNECTED,
  - DISCONNECTED.

### 5. Сущность «API-ключи»

Для каждой подключенной биржи хранятся:
- api_key,
- secret_key,
- passphrase (если требуется),
- дата добавления,
- статус активности:
  - ACTIVE,
  - DISABLED.

API-ключи:
- используются только серверной частью,
- не передаются в frontend.

### 6. Сущность «Торговая пара»

Для каждой торговой пары хранятся:
- уникальный идентификатор пары,
- универсальное имя пары (например, BTCUSDT),
- объём V,
- спред входа,
- спред выхода,
- количество ордеров N,
- текущий статус:
  - PAUSE,
  - READY,
  - TRADE,
  - ERROR,
- дата создания,
- дата последнего изменения,
- количество завершённых арбитражных циклов,
- суммарный PNL по паре.

### 7. Сущность «Арбитражный цикл»

Для каждого арбитражного цикла хранится:
- уникальный идентификатор цикла (trade_id),
- ссылка на торговую пару,
- время начала цикла,
- время завершения цикла,
- статус цикла:
  - OPEN,
  - CLOSED,
  - ERROR,
- суммарный объём по циклу,
- суммарный PNL по циклу.

### 8. Сущность «Часть ордера (часть позиции)»

Для каждой части арбитражного цикла хранится:
- уникальный идентификатор части,
- номер части (1/N, 2/N и т.д.),
- ссылка на trade_id,
- объём части,
- биржа Long,
- биржа Short,
- фактический объём Long,
- фактический объём Short,
- средняя цена входа Long,
- средняя цена входа Short,
- средняя цена выхода Long,
- средняя цена выхода Short,
- статус части:
  - OPENED,
  - CLOSED,
  - ERROR,
- причина ошибки (если есть).

### 9. Сущность «Позиция»

Для каждой фактической позиции на бирже хранится:
- биржа,
- торговая пара,
- направление:
  - LONG,
  - SHORT,
- фактический объём,
- средняя цена входа,
- текущий статус:
  - OPEN,
  - CLOSED,
  - LIQUIDATED (фиксируется, логика v1 дополнительно не обрабатывает).

### 10. Сущность «Балансы»

Хранится последняя известная информация по:
- балансу фьючерсного аккаунта,
- доступной марже,
- используемой марже,
- времени последнего обновления.

### 11. Сущность «Логи»

В базе данных должны сохраняться:
- торговые логи (секция «Торговля»),
- логи ошибок (секция «ERROR»).

Каждый лог содержит:
- дату и время,
- тип:
  - TRADE,
  - ERROR,
- текст сообщения.

**Формат логов остаётся строго таким, как описан в ТЗ.**

**Структурированные JSON-логи в версии v1 не используются.**

### 12. Хранение PNL

PNL:
- рассчитывается:
  - за каждый завершённый арбитражный цикл,
  - как результат разницы цен входа/выхода по обеим ногам с учётом комиссий,
- сохраняется:
  - на уровне арбитражного цикла,
  - агрегируется на уровне торговой пары.

### 13. Резервное копирование и восстановление

В версии v1:
- автоматическое резервное копирование базы данных не является обязательным требованием,
- ответственность за:
  - создание бэкапов,
  - сохранность базы,
  - возможное восстановление,
  возлагается на пользователя.

### 14. Поведение базы данных при перезапуске системы

После перезапуска терминала:
- база данных используется как:
  - источник всех торговых пар,
  - источник всех параметров,
  - источник истории сделок,
- фактическое состояние на биржах дополнительно сверяется через API,
- торговые пары по умолчанию переводятся в статус PAUSE.

## Архитектура проекта

### 1. Общая схема

Терминал представляет собой однопользовательскую систему:
- 1 пользователь → 1 VPS → 1 экземпляр терминала.

На одном VPS размещаются:
1. Backend-сервис (торговое ядро + REST/WebSocket API).
2. Frontend-веб-интерфейс.
3. База данных.
4. Службы логирования и мониторинга состояния (в рамках backend).

Компоненты взаимодействуют следующим образом:
- Frontend общается только с Backend через HTTP/WebSocket API.
- Backend:
  - управляет торговой логикой,
  - держит подключения к биржам,
  - работает с БД,
  - публикует данные для Frontend.
- БД служит единым источником хранения конфигурации, исторических данных и статистики.

### 2. Основные компоненты Backend

Backend логически делится на следующие подсистемы:

1. Модуль управления подключениями к биржам (Exchange Manager)
2. Модуль рыночных данных (Market Data / Order Book Engine)
3. Торговое ядро (Trading Engine)
4. Модуль управления торговыми парами и статусами (Pairs/State Manager)
5. Модуль PNL и учёта сделок (PNL & Accounting)
6. Модуль логирования (Logging)
7. Модуль REST/WebSocket API для Frontend
8. Модуль работы с базой данных (DB Layer)
9. Модуль конфигурации (Config Manager)

#### 2.1. Exchange Manager

Отвечает за:
- хранение и использование API-ключей,
- установление и поддержание:
  - REST-подключений,
  - WebSocket-подписок,
- унификацию форматов:
  - торговых пар,
  - ответов бирж,
- обработку:
  - сетевых ошибок,
  - ошибок лимитов,
  - временных банов.

Exchange Manager предоставляет единый интерфейс для других модулей:
- send_market_order(...)
- get_balances(...)
- get_positions(...)
- subscribe_order_book(...)
- и т.д.

#### 2.2. Market Data / Order Book Engine

Отвечает за:
- приём данных стаканов и best bid/ask по WebSocket,
- хранение актуального состояния рынка для всех пар в статусе READY,
- расчёт:
  - best bid / best ask для быстрых фильтров,
  - VWAP по стакану для заданного объёма (или части объёма),
  - оценки ликвидности для входа/выхода.

Market Data-движок:
- работает в режиме подписок от бирж,
- предоставляет торговому ядру быстрый доступ к агрегированным данным по каждой паре и бирже.

#### 2.3. Trading Engine (Торговое ядро)

Это центральный модуль, реализующий:
- логику поиска арбитражных ситуаций,
- применение быстрых фильтров по спреду,
- финальный расчёт CleanSpread по VWAP,
- логику входа частями и выхода частями,
- контроль:
  - симметрии ног,
  - статусов пар (READY / TRADE / ERROR / PAUSE),
  - реакций на ошибки исполнения.

Основные задачи:
- цикл обработки для каждой пары в статусе READY/TRADE:
  - получение данных от Market Data Engine,
  - принятие решений → формирование торговых команд,
  - взаимодействие с Exchange Manager для отправки ордеров,
  - обработка ответов, обновление состояний,
  - запись результатов в БД и логи.

#### 2.4. Pairs / State Manager

Отвечает за:
- хранение в оперативной памяти:
  - списка торговых пар,
  - их текущих статусов,
  - текущих арбитражных циклов,
  - прогресса по частям.
- синхронизацию этих данных с БД,
- переходы статусов:
  - PAUSE → READY,
  - READY → TRADE,
  - TRADE → READY/PAUSE/ERROR,
  - ERROR → PAUSE (после «Сброса»).

State Manager:
- является «единым источником правды» по состояниям в runtime,
- предоставляет интерфейсы для:
  - Trading Engine,
  - API-слоя (для веб-интерфейса).

#### 2.5. PNL & Accounting

Отвечает за:
- расчёт PNL:
  - по каждой части,
  - по арбитражному циклу,
  - по торговой паре (агрегированно),
- учёт:
  - цен входа/выхода,
  - комиссий,
  - фактических объёмов.

После завершения цикла:
- записывает:
  - PNL,
  - статистику,
- обновляет соответствующие поля в БД,
- предоставляет данные для отображения во вкладке «Бот».

#### 2.6. Logging

Отвечает за:
- централизованный сбор логов:
  - торговых (секция «Торговля»),
  - ошибок (секция «ERROR»),
- запись логов:
  - в БД,
  - при необходимости — в файлы.

Логика форматов:
- соответствует текстовому формату, описанному в разделе «Логи»,
- обеспечивает доступ логов через API во вкладке «Логи».

#### 2.7. REST/WebSocket API для Frontend

Backend поднимает HTTP(S)/WebSocket-сервис, который:
- предоставляет REST-эндпоинты для:
  - авторизации,
  - получения списка бирж и их статусов,
  - получения списка пар и их параметров,
  - изменения статусов пар (Старт/Пауза/Сброс/Удалить),
  - добавления новых пар,
  - получения текущих балансов,
  - получения логов.
- предоставляет WebSocket-канал для:
  - push-обновлений статусов,
  - обновлений PNL,
  - обновлений логов в реальном времени.

Frontend не обращается к биржам напрямую, только к этому API.

#### 2.8. DB Layer (Слой работы с БД)

Отвечает за:
- чтение/запись:
  - торговых пар,
  - циклов,
  - частей,
  - логов,
  - ключей,
  - балансов,
- транзакционную целостность данных,
- миграции схемы БД (по мере развития проекта).

Предоставляет Trading Engine и другим модулям высокоуровневые операции:
- save_trade_cycle(...)
- update_pair_status(...)
- log_event(...)
- и т.п.

#### 2.9. Config Manager

Отвечает за:
- загрузку конфигурации из файлов:
  - логин/пароль веб-интерфейса,
  - лимиты по количеству пар и одновременно активным арбитражам,
  - параметры подключения к БД,
  - прочие настройки.

Позволяет:
- централизованно менять параметры без перекомпиляции/пересборки кода.

### 3. Frontend

Frontend — это одностраничное веб-приложение (SPA), работающее в браузере пользователя, которое:
- подключается к Backend через REST и WebSocket,
- реализует:
  - вкладку «Бот»,
  - вкладку «Подключения»,
  - вкладку «Логи».

Вся бизнес-логика арбитража и работы с биржами находится на стороне Backend.

Frontend:
- не содержит чувствительных данных (API-ключи, логика торговли),
- отвечает только за отображение и управление действиями пользователя.

### 4. Взаимодействие компонентов по сценариям

#### 4.1. Сценарий «Добавление торговой пары»

1. Пользователь в Frontend → заполняет форму → «Добавить торговую пару».
2. Frontend отправляет запрос в Backend (REST).
3. Backend (API) → валидирует данные → вызывает DB Layer → создаёт запись о паре в статусе PAUSE.
4. State Manager обновляет внутренний список пар.
5. Frontend получает обновлённый список пар и отображает новую пару.

#### 4.2. Сценарий «Старт пары» (PAUSE → READY)

1. Пользователь нажимает «Старт» в интерфейсе.
2. Frontend отправляет запрос в Backend.
3. Backend:
   - через State Manager меняет статус пары на READY,
   - Market Data Engine начинает подписки и мониторинг по паре.
4. Trading Engine включает пару в цикл обработки решений.
5. Статус и кнопки в интерфейсе обновляются через WebSocket/REST.

#### 4.3. Сценарий «Вход в арбитраж»

1. Trading Engine получает от Market Data Engine данные:
   - best bid/ask,
   - стаканы.
2. Выполняет:
   - быстрый фильтр по спреду,
   - расчёт VWAP и CleanSpread по объёму части,
   - проверку ликвидности и маржи.
3. При выполнении условий:
   - формирует команду на вход,
   - через Exchange Manager отправляет два рыночных ордера.
4. Exchange Manager возвращает информацию об исполнении.
5. Trading Engine и PNL/Accounting:
   - фиксируют вход части,
   - обновляют цикл в БД.
6. Во вкладку «Логи» пишется запись в секцию «Торговля».

#### 4.4. Сценарий «Ошибка одной ноги»

1. Exchange Manager сообщает, что:
   - одна нога исполнена,
   - вторая — нет.
2. Trading Engine:
   - отдаёт команду Exchange Manager на закрытие исполненной ноги,
   - через State Manager переводит пару в ERROR.
3. Logging:
   - пишет запись в секцию «ERROR».
4. Frontend:
   - обновляет статус пары,
   - показывает пользователю кнопку «Сброс».

#### 4.5. Сценарий «Сброс» (ERROR → PAUSE)

1. Пользователь нажимает кнопку «Сброс».
2. Frontend → запрос в Backend.
3. Backend:
   - через Exchange Manager принудительно закрывает все открытые позиции по паре,
   - через State Manager переводит пару в PAUSE.
4. Logging:
   - пишет лог в секцию «ERROR» или «Торговля» (по реализации).
5. Интерфейс отображает обновлённое состояние.

### 5. Модель выполнения (конкурентность)

Терминал должен быть спроектирован таким образом, чтобы:
- одновременно обрабатывать:
  - несколько подключений к биржам,
  - несколько активных торговых пар,
  - несколько одновременных арбитражных циклов.

Рекомендуемая модель:
- асинхронная событийная модель (event loop):
  - отдельные корутины/таски для:
    - приёма рыночных данных,
    - логики Trading Engine,
    - работы API,
    - периодической синхронизации с биржами.
- без блокирующих операций в основном цикле.

### 6. Развёртывание на VPS

На одном VPS должна быть обеспечена работа:

1. **Backend-сервиса:**
   - запускаемого через systemd/supervisor/pm2 (по выбранному стеку),
   - с автоперезапуском при падении.
2. **Frontend-приложения:**
   - как статический сервер (Nginx/встроенный HTTP-сервер).
3. **Базы данных:**
   - как отдельного процесса (например, PostgreSQL/SQLite, в зависимости от реализации).

Все компоненты должны быть сконфигурированы так, чтобы:
- после перезапуска VPS система автоматически возвращалась в рабочее состояние,
- терминал сразу начинал:
  - переподключения к биржам,
  - синхронизацию состояния,
  - отображение данных в интерфейсе.
